{% extends 'base.html' %}

{% block title %}Create User{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-title">
        <h4>Create User</h4>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('auth_register') }}" id="register-form" novalidate>
          <!-- Username -->
          <div class="form-group">
            <label>Username</label>
            <input
              name="username"
              type="text"
              class="form-control"
              id="username-input"
              required
            >
            <small class="form-text text-muted">
              This will be your login username.
            </small>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary mt-2"
              id="check-btn"
            >
              Check Availability
            </button>
            <div id="username-check-result" class="mt-2"></div>
          </div>

          <!-- Password -->
          <div class="form-group">
            <label>Password</label>
            <input
              name="password"
              type="password"
              class="form-control"
              required
            >
          </div>

          <!-- Full Name -->
          <div class="form-group">
            <label>Full Name</label>
            <input
              name="full_name"
              type="text"
              class="form-control"
              required
            >
          </div>

          <!-- Date of Birth -->
          <div class="form-group">
            <label>Date of Birth</label>
            <input
              name="date_of_birth"
              type="date"
              class="form-control"
              required
            >
          </div>

          <!-- Submit -->
          <button
            type="submit"
            class="btn btn-primary mt-3"
            id="submit-btn"
            disabled
          >
            Create Account
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  let usernameChecked = false;
  let isAvailable    = false;

  const input       = document.getElementById('username-input');
  const checkBtn    = document.getElementById('check-btn');
  const resultDiv   = document.getElementById('username-check-result');
  const submitBtn   = document.getElementById('submit-btn');
  const form        = document.getElementById('register-form');

  checkBtn.addEventListener('click', async () => {
    const uname = input.value.trim();
    // reset
    usernameChecked = false;
    isAvailable    = false;
    submitBtn.disabled = true;
    resultDiv.textContent = '';
    resultDiv.classList.remove('text-success','text-danger');

    if (!uname) {
      resultDiv.textContent = '⚠️ Enter a username first.';
      resultDiv.classList.add('text-danger');
      return;
    }
    try {
      const res = await fetch(`/auth/check_username?username=${encodeURIComponent(uname)}`);
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Server error');
      }
      const { available } = await res.json();
      usernameChecked = true;
      if (available) {
        isAvailable = true;
        resultDiv.textContent = '✅ Username is available!';
        resultDiv.classList.add('text-success');
        submitBtn.disabled = false;
      } else {
        resultDiv.textContent = '❌ Username is already taken.';
        resultDiv.classList.add('text-danger');
      }
    } catch (err) {
      resultDiv.textContent = `Error: ${err.message}`;
      resultDiv.classList.add('text-danger');
    }
  });

  form.addEventListener('submit', e => {
    // Prevent submitting if not checked or not available
    if (!usernameChecked) {
      e.preventDefault();
      alert('Please click “Check Availability” before submitting.');
    } else if (!isAvailable) {
      e.preventDefault();
      alert('That username is unavailable – please choose another and check again.');
    }
  });
</script>
{% endblock %}
